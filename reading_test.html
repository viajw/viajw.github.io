<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ë³¸ì–´ ë¡œë§ˆì ì½ê¸° í€´ì¦ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Pretendard', 'Noto Sans JP', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    
    <style>
        ruby rt { font-size: 0.6em; user-select: none; color: #6b7280; }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        #romaji-input::placeholder {
            font-family: 'Pretendard', 'Noto Sans JP', 'sans-serif';
            color: #9ca3af; 
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen font-sans">

    <div class="container mx-auto max-w-2xl w-full p-4 sm:p-6">
        
        <div id="setup-view" class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">ë¡œë§ˆì ì½ê¸° í€´ì¦ˆ</h1>
            <p class="text-center text-gray-500 mb-8 text-sm">ì œì‹œëœ ì¼ë³¸ì–´ì˜ ë°œìŒì„ ë¡œë§ˆìë¡œ ì…ë ¥í•˜ì„¸ìš”.</p>
            
            <div class="mb-8">
                <h2 class="text-lg font-bold text-gray-700 mb-3 flex justify-between items-center">
                    <span>ì¶œì œ ë²”ìœ„ ì„ íƒ</span>
                    <button id="load-japanese-voca-btn" class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm font-semibold py-1.5 px-3 rounded-lg transition-colors flex items-center">
                        <span id="voca-btn-text">ë‹¨ì–´ì¥ í¬í•¨í•˜ê¸°</span>
                    </button>
                </h2>
                <div class="border rounded-lg p-4 max-h-64 overflow-y-auto bg-gray-50">
                    <div class="flex items-center mb-3 pb-3 border-b">
                        <input type="checkbox" id="select-all-groups" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="select-all-groups" class="ml-3 block text-base font-semibold text-gray-900">ì „ì²´ ì„ íƒ</label>
                    </div>
                    <div id="group-checkbox-container">
                        <p class="text-gray-500">íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>

            <button id="start-quiz-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-xl transition-all duration-200 shadow-lg text-lg">
                í€´ì¦ˆ ì‹œì‘í•˜ê¸°
            </button>
            <p id="setup-error" class="text-red-500 text-sm mt-3 text-center h-5"></p>
        </div>

        <div id="quiz-view" class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 hidden flex flex-col min-h-[500px]">
            
            <div class="flex justify-between items-center mb-8 pb-4 border-b">
                <div class="flex gap-4 text-sm font-semibold">
                    <span class="text-green-600">ì •ë‹µ: <span id="score-correct">0</span></span>
                    <span class="text-red-500">ì˜¤ë‹µ: <span id="score-wrong">0</span></span>
                </div>
                <div class="flex items-center gap-3">
                    <button id="wrong-note-btn" class="text-xs font-bold text-white bg-red-500 hover:bg-red-600 px-3 py-1 rounded-full transition-colors hidden">
                        ì˜¤ë‹µ ë…¸íŠ¸ (<span id="wrong-note-count">0</span>)
                    </button>
                    <div class="text-sm text-gray-400 font-medium">
                        ë‚¨ì€ ë¬¸ì œ: <span id="score-remain">0</span>
                    </div>
                </div>
            </div>

            <div class="flex-grow flex flex-col items-center justify-center mb-6">
                <div id="question-word" class="text-5xl sm:text-6xl font-bold text-gray-800 text-center break-keep mb-8">
                </div>

                <div class="w-full max-w-md">
                    <input type="text" id="romaji-input" autocomplete="off"
                        class="w-full text-center text-2xl py-3 px-4 border-b-2 border-gray-300 focus:border-indigo-500 outline-none bg-transparent transition-colors placeholder-gray-300 font-mono"
                        placeholder="ë¡œë§ˆìë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div id="feedback-msg" class="text-center mt-4 font-bold h-6 text-lg transition-all duration-200"></div>
            </div>

            <div id="result-feedback" class="hidden bg-gray-50 rounded-xl p-5 mb-6 text-center border border-gray-200 fade-in mt-2">
                <div class="flex justify-around items-center py-1">
                    
                    <div class="flex-1 text-center pr-2">
                        <span class="text-xs text-gray-400 block mb-1">ì •ë‹µ ë¡œë§ˆì</span>
                        <span id="feedback-romaji" class="text-xl font-bold text-indigo-600 font-mono"></span>
                    </div>
                    
                    <div class="h-12 w-px bg-gray-300 mx-3"></div>
                    
                    <div class="flex-1 text-center pl-2">
                        <span class="text-xs text-gray-400 block mb-1">ë‹¨ì–´ ëœ»</span>
                        <span id="feedback-meaning" class="text-lg text-gray-800 break-keep"></span>
                    </div>
                </div>
            </div>

            <div class="mt-auto">
                <button id="check-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-md transition-colors text-lg">
                    ì •ë‹µ í™•ì¸
                </button>
                <button id="next-btn" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-4 rounded-xl shadow-md transition-colors text-lg hidden">
                    ë‹¤ìŒ ë¬¸ì œ
                </button>
            </div>
            
            <div class="mt-4 text-center">
                <button id="quit-btn" class="text-xs text-gray-400 hover:text-gray-600 underline">ê·¸ë§Œë‘ê¸°</button>
            </div>
        </div>

        <div id="final-view" class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 hidden text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">í€´ì¦ˆ ì™„ë£Œ!</h1>
            <div class="text-6xl mb-2">ğŸ‰</div>
            <div class="text-gray-600 mb-8">ëª¨ë“  ë¬¸ì œë¥¼ í’€ì—ˆìŠµë‹ˆë‹¤.</div>

            <div class="flex justify-center gap-8 mb-8 bg-gray-50 p-6 rounded-xl">
                <div class="text-center">
                    <p class="text-sm text-gray-500 mb-1">ë§ì€ ê°œìˆ˜</p>
                    <p class="text-3xl font-bold text-green-600" id="final-correct">0</p>
                </div>
                <div class="w-px bg-gray-300"></div>
                <div class="text-center">
                    <p class="text-sm text-gray-500 mb-1">í‹€ë¦° ê°œìˆ˜</p>
                    <p class="text-3xl font-bold text-red-500" id="final-wrong">0</p>
                </div>
            </div>
            <button id="final-wrong-note-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl shadow-md mb-3 transition-all hidden">
                ì˜¤ë‹µ ë…¸íŠ¸ í™•ì¸ (<span id="final-wrong-note-count">0</span>)
            </button>
            <button id="restart-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-all">
                ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>

    </div>

    <div id="wrong-note-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h2 class="text-xl font-bold text-gray-800">ì˜¤ë‹µ ë…¸íŠ¸</h2>
                <button onclick="closeWrongNoteModal()" class="text-3xl text-gray-500 hover:text-gray-800 font-light leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <div id="wrong-note-list" class="space-y-4">
                    </div>
                <p id="wrong-note-empty" class="text-center text-gray-500 hidden mt-4">ì˜¤ë‹µ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë‘ ì •ë‹µì´ì—ìš”!</p>
            </div>
            <div class="p-6 border-t flex justify-end gap-3 sticky bottom-0 bg-white z-10">
                <button id="share-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl transition-colors text-sm flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.287.696.287 1.093s-.107.77-.287 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z" />
                    </svg>
                    ê³µìœ í•˜ê¸°
                </button>
                <button onclick="closeWrongNoteModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl transition-colors text-sm">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>


    <script>
        let allVocabGroups = {};
        let currentFilesToLoad = ['romaji_reading.voca']; // ê¸°ë³¸ íŒŒì¼
        let quizQueue = [];
        let currentQuestion = null;
        let correctCount = 0;
        let wrongCount = 0;
        let wrongAnswers = [];

        const setupView = document.getElementById('setup-view');
        const quizView = document.getElementById('quiz-view');
        const finalView = document.getElementById('final-view');
        
        const groupCheckboxContainer = document.getElementById('group-checkbox-container');
        const selectAllGroups = document.getElementById('select-all-groups');
        const setupError = document.getElementById('setup-error');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const loadJapaneseVocaBtn = document.getElementById('load-japanese-voca-btn');
        const vocaBtnText = document.getElementById('voca-btn-text');

        const scoreCorrectEl = document.getElementById('score-correct');
        const scoreWrongEl = document.getElementById('score-wrong');
        const scoreRemainEl = document.getElementById('score-remain');
        const wrongNoteBtn = document.getElementById('wrong-note-btn');
        const wrongNoteCountEl = document.getElementById('wrong-note-count');

        const questionWordEl = document.getElementById('question-word');
        const romajiInput = document.getElementById('romaji-input');
        const feedbackMsg = document.getElementById('feedback-msg');
        const resultFeedback = document.getElementById('result-feedback');
        const feedbackRomaji = document.getElementById('feedback-romaji');
        const feedbackMeaning = document.getElementById('feedback-meaning');

        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const quitBtn = document.getElementById('quit-btn');
        const restartBtn = document.getElementById('restart-btn');
        const finalWrongNoteBtn = document.getElementById('final-wrong-note-btn');

        const wrongNoteModal = document.getElementById('wrong-note-modal');
        const wrongNoteList = document.getElementById('wrong-note-list');
        const wrongNoteEmpty = document.getElementById('wrong-note-empty');
        const shareBtn = document.getElementById('share-btn');
        const finalWrongNoteCount = document.getElementById('final-wrong-note-count');

        // --- íŒŒì¼ ë¡œë“œ ë° íŒŒì‹± í•¨ìˆ˜ í†µí•© ---
        async function fetchAndParseVocab(filename) {
            try {
                const response = await fetch(filename, { cache: 'no-store' });
                if (!response.ok) {
                    if(filename !== 'romaji_reading.voca') {
                        console.warn(`${filename} íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê²½ê³ )`);
                    } else {
                        throw new Error(`ì£¼ìš” íŒŒì¼ ${filename}ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    }
                    return {};
                }
                const text = await response.text();
                
                let fileGroups = {};
                const isJapaneseVoca = filename.includes('japanese.voca');
                let currentGroup = isJapaneseVoca ? 'ë‹¨ì–´ì¥ - ë¯¸ë¶„ë¥˜' : 'ë¯¸ë¶„ë¥˜'; 

                text.split('\n').forEach(line => {
                    line = line.trim();
                    if (!line || line.startsWith('#')) return;
                    
                    if (line.startsWith('@')) {
                        currentGroup = isJapaneseVoca ? 
                            `ë‹¨ì–´ì¥ - ${line.substring(1).trim()}` : 
                            line.substring(1).trim();
                        if (!fileGroups[currentGroup]) fileGroups[currentGroup] = [];
                    } else {
                        const parts = line.split(' - ');
                        if (parts.length >= 2) {
                            const rawWord = parts[0].trim();
                            const meaning = parts.slice(1).join(' - ').trim();
                            
                            let reading = rawWord;
                            const match = rawWord.match(/\[([^\]]+)\]/);
                            if (match) {
                                reading = match[1];
                            }
                            
                            if (!fileGroups[currentGroup]) fileGroups[currentGroup] = [];
                            fileGroups[currentGroup].push({ 
                                displayWord: rawWord.replace(/\[[^\]]+\]/g, ''),
                                fullWord: rawWord,
                                reading: reading,
                                meaning: meaning 
                            });
                        }
                    }
                });
                return fileGroups;
            } catch (error) {
                setupError.textContent = `ë‹¨ì–´ì¥ ë¡œë“œ ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜: ${error.message}`;
                groupCheckboxContainer.innerHTML = `<p class="text-red-500">ë¡œë“œ ì‹¤íŒ¨: ${error.message}</p>`;
                return {};
            }
        }

        async function loadVocabulary() {
            allVocabGroups = {};
            groupCheckboxContainer.innerHTML = `<p class="text-gray-500">ì„ íƒëœ íŒŒì¼ë“¤ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
            setupError.textContent = '';
            
            let totalGroups = {};
            
            for (const filename of currentFilesToLoad) {
                const groups = await fetchAndParseVocab(filename);
                Object.assign(totalGroups, groups);
            }
            
            allVocabGroups = totalGroups;
            
            if (Object.keys(allVocabGroups).length === 0) {
                groupCheckboxContainer.innerHTML = '<p class="text-red-500">ë¡œë“œëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.</p>';
                return;
            }

            displayGroupCheckboxes();
        }

        function displayGroupCheckboxes() {
            groupCheckboxContainer.innerHTML = '';
            const groups = Object.keys(allVocabGroups);
            if (groups.length === 0) {
                groupCheckboxContainer.innerHTML = '<p class="text-gray-500">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            groups.forEach(g => {
                const div = document.createElement('div');
                div.className = 'flex items-center mb-2';
                div.innerHTML = `
                    <input type="checkbox" id="g-${g}" name="group-select" value="${g}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="g-${g}" class="ml-3 text-sm text-gray-700 cursor-pointer select-none">${g} (${allVocabGroups[g].length})</label>
                `;
                groupCheckboxContainer.appendChild(div);
            });
            selectAllGroups.checked = false;
        }

        const hepburnMap = {
            'ã‚':'a', 'ã„':'i', 'ã†':'u', 'ãˆ':'e', 'ãŠ':'o',
            'ã‹':'ka', 'ã':'ki', 'ã':'ku', 'ã‘':'ke', 'ã“':'ko',
            'ã•':'sa', 'ã—':'shi', 'ã™':'su', 'ã›':'se', 'ã':'so',
            'ãŸ':'ta', 'ã¡':'chi', 'ã¤':'tsu', 'ã¦':'te', 'ã¨':'to',
            'ãª':'na', 'ã«':'ni', 'ã¬':'nu', 'ã­':'ne', 'ã®':'no',
            'ã¯':'ha', 'ã²':'hi', 'ãµ':'fu', 'ã¸':'he', 'ã»':'ho',
            'ã¾':'ma', 'ã¿':'mi', 'ã‚€':'mu', 'ã‚':'me', 'ã‚‚':'mo',
            'ã‚„':'ya', 'ã‚†':'yu', 'ã‚ˆ':'yo',
            'ã‚‰':'ra', 'ã‚Š':'ri', 'ã‚‹':'ru', 'ã‚Œ':'re', 'ã‚':'ro',
            'ã‚':'wa', 'ã‚’':'o', 'ã‚“':'n',
            
            'ãŒ':'ga', 'ã':'gi', 'ã':'gu', 'ã’':'ge', 'ã”':'go',
            'ã–':'za', 'ã˜':'ji', 'ãš':'zu', 'ãœ':'ze', 'ã':'zo',
            'ã ':'da', 'ã¢':'ji', 'ã¥':'zu', 'ã§':'de', 'ã©':'do',
            'ã°':'ba', 'ã³':'bi', 'ã¶':'bu', 'ã¹':'be', 'ã¼':'bo',
            'ã±':'pa', 'ã´':'pi', 'ã·':'pu', 'ãº':'pe', 'ã½':'po',
            
            'ã‚¢':'a', 'ã‚¤':'i', 'ã‚¦':'u', 'ã‚¨':'e', 'ã‚ª':'o',
            'ã‚«':'ka', 'ã‚­':'ki', 'ã‚¯':'ku', 'ã‚±':'ke', 'ã‚³':'ko',
            'ã‚µ':'sa', 'ã‚·':'shi', 'ã‚¹':'su', 'ã‚»':'se', 'ã‚½':'so',
            'ã‚¿':'ta', 'ãƒ':'chi', 'ãƒ„':'tsu', 'ãƒ†':'te', 'ãƒˆ':'to',
            'ãƒŠ':'na', 'ãƒ‹':'ni', 'ãƒŒ':'nu', 'ãƒ':'ne', 'ãƒ':'no',
            'ãƒ':'ha', 'ãƒ’':'hi', 'ãƒ•':'fu', 'ãƒ˜':'he', 'ãƒ›':'ho',
            'ãƒ':'ma', 'ãƒŸ':'mi', 'ãƒ ':'mu', 'ãƒ¡':'me', 'ãƒ¢':'mo',
            'ãƒ¤':'ya', 'ãƒ¦':'yu', 'ãƒ¨':'yo',
            'ãƒ©':'ra', 'ãƒª':'ri', 'ãƒ«':'ru', 'ãƒ¬':'re', 'ãƒ­':'ro',
            'ãƒ¯':'wa', 'ãƒ²':'o', 'ãƒ³':'n',
            'ã‚¬':'ga', 'ã‚®':'gi', 'ã‚°':'gu', 'ã‚²':'ge', 'ã‚´':'go',
            'ã‚¶':'za', 'ã‚¸':'ji', 'ã‚º':'zu', 'ã‚¼':'ze', 'ã‚¾':'zo',
            'ãƒ€':'da', 'ãƒ‚':'ji', 'ãƒ…':'zu', 'ãƒ‡':'de', 'ãƒ‰':'do',
            'ãƒ':'ba', 'ãƒ“':'bi', 'ãƒ–':'bu', 'ãƒ™':'be', 'ãƒœ':'bo',
            'ãƒ‘':'pa', 'ãƒ”':'pi', 'ãƒ—':'pu', 'ãƒš':'pe', 'ãƒ':'po',
            'ãƒ¼': '-'
        };

        const compoundsMap = {
            'ã—ã‚ƒ':'sha', 'ã—ã‚…':'shu', 'ã—ã‚‡':'sho',
            'ã¡ã‚ƒ':'cha', 'ã¡ã‚…':'chu', 'ã¡ã‚‡':'cho',
            'ã˜ã‚ƒ':'ja', 'ã˜ã‚…':'ju', 'ã˜ã‚‡':'jo',
            'ãã‚ƒ':'kya', 'ãã‚…':'kyu', 'ãã‚‡':'kyo',
            'ãã‚ƒ':'gya', 'ãã‚…':'gyu', 'ãã‚‡':'gyo',
            'ã«ã‚ƒ':'nya', 'ã«ã‚…':'nyu', 'ã«ã‚‡':'nyo',
            'ã²ã‚ƒ':'hya', 'ã²ã‚…':'hyu', 'ã²ã‚‡':'hyo',
            'ã³ã‚ƒ':'bya', 'ã³ã‚…':'byu', 'ã³ã‚‡':'byo',
            'ã´ã‚ƒ':'pya', 'ã´ã‚…':'pyu', 'ã´ã‚‡':'pyo',
            'ã¿ã‚ƒ':'mya', 'ã¿ã‚…':'myu', 'ã¿ã‚‡':'myo',
            'ã‚Šã‚ƒ':'rya', 'ã‚Šã‚…':'ryu', 'ã‚Šã‚‡':'ryo',
            
            'ã‚·ãƒ£':'sha', 'ã‚·ãƒ¥':'shu', 'ã‚·ãƒ§':'sho',
            'ãƒãƒ£':'cha', 'ãƒãƒ¥':'chu', 'ãƒãƒ§':'cho',
            'ã‚¸ãƒ£':'ja', 'ã‚¸ãƒ¥':'ju', 'ã‚¸ãƒ§':'jo',
            'ã‚­ãƒ£':'kya', 'ã‚­ãƒ¥':'kyu', 'ã‚­ãƒ§':'kyo',
        };

        function toRomaji(kana) {
            let result = '';
            let i = 0;
            while (i < kana.length) {
                const char = kana[i];
                const nextChar = kana[i+1];
                const twoChars = char + (nextChar || '');
                
                if (compoundsMap[twoChars]) {
                    result += compoundsMap[twoChars];
                    i += 2;
                    continue;
                }

                if (char === 'ã£' || char === 'ãƒƒ') {
                    if (nextChar) {
                        const nextTwo = nextChar + (kana[i+2] || '');
                        let nextRomaji = '';
                        if (compoundsMap[nextTwo]) {
                            nextRomaji = compoundsMap[nextTwo];
                        } else {
                            nextRomaji = hepburnMap[nextChar] || '';
                        }
                        
                        if (nextRomaji) {
                            result += nextRomaji.charAt(0);
                            i++;
                            continue;
                        }
                    }
                }
                
                if (hepburnMap[char]) {
                    result += hepburnMap[char];
                    i++;
                } else {
                    result += char;
                    i++;
                }
            }
            return result;
        }

        // Fisher-Yates Shuffle ì•Œê³ ë¦¬ì¦˜ (ëœë¤ ì„ê¸° ê°•í™”)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startQuiz() {
            const checked = document.querySelectorAll('input[name="group-select"]:checked');
            if (checked.length === 0) {
                setupError.textContent = 'ìµœì†Œ í•˜ë‚˜ì˜ ê·¸ë£¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                return;
            }
            setupError.textContent = '';

            quizQueue = [];
            checked.forEach(cb => {
                quizQueue.push(...allVocabGroups[cb.value]);
            });

            // ê°•í™”ëœ ì„ê¸° ê¸°ëŠ¥ ì ìš©
            shuffleArray(quizQueue);

            if (quizQueue.length === 0) {
                setupError.textContent = 'ì„ íƒí•œ ê·¸ë£¹ì— ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }

            correctCount = 0;
            wrongCount = 0;
            wrongAnswers = [];
            updateScore();

            setupView.classList.add('hidden');
            quizView.classList.remove('hidden');
            finalView.classList.add('hidden');

            loadNextQuestion();
        }

        function loadNextQuestion() {
            if (quizQueue.length === 0) {
                finishQuiz();
                return;
            }

            currentQuestion = quizQueue.pop();
            updateScore();

            questionWordEl.innerHTML = currentQuestion.displayWord;
            
            romajiInput.value = '';
            romajiInput.disabled = false;
            romajiInput.focus();
            
            feedbackMsg.textContent = '';
            resultFeedback.classList.add('hidden');
            
            checkBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
        }

        function checkAnswer() {
            const userMsg = romajiInput.value.trim().toLowerCase();
            if (!userMsg) return;

            const correctRomaji = toRomaji(currentQuestion.reading);
            const isCorrect = (userMsg === correctRomaji);

            romajiInput.disabled = true;
            
            resultFeedback.classList.remove('hidden');
            feedbackRomaji.textContent = correctRomaji;
            feedbackMeaning.textContent = currentQuestion.meaning;

            if (isCorrect) {
                correctCount++;
                romajiInput.classList.add('text-green-600', 'font-bold');
                feedbackMsg.textContent = "ì •ë‹µì…ë‹ˆë‹¤! âœ…";
                feedbackMsg.className = "text-center mt-4 font-bold h-6 text-lg text-green-600 fade-in";
                
            } else {
                wrongCount++;
                romajiInput.classList.add('text-red-500', 'font-bold', 'shake');
                feedbackMsg.textContent = "í‹€ë ¸ìŠµë‹ˆë‹¤ âŒ";
                feedbackMsg.className = "text-center mt-4 font-bold h-6 text-lg text-red-500 fade-in";
                
                wrongAnswers.push({
                    word: currentQuestion.displayWord,
                    wrongRomaji: userMsg,
                    correctRomaji: correctRomaji,
                    meaning: currentQuestion.meaning
                });
            }
            
            checkBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
            nextBtn.focus();
            
            updateScore();
        }

        function updateScore() {
            scoreCorrectEl.textContent = correctCount;
            scoreWrongEl.textContent = wrongCount;
            scoreRemainEl.textContent = quizQueue.length;
            
            wrongNoteCountEl.textContent = wrongAnswers.length;
            finalWrongNoteCount.textContent = wrongAnswers.length;

            if (wrongAnswers.length > 0) {
                wrongNoteBtn.classList.remove('hidden');
                finalWrongNoteBtn.classList.remove('hidden');
            } else {
                wrongNoteBtn.classList.add('hidden');
                finalWrongNoteBtn.classList.add('hidden');
            }
        }

        function finishQuiz() {
            quizView.classList.add('hidden');
            finalView.classList.remove('hidden');
            
            document.getElementById('final-correct').textContent = correctCount;
            document.getElementById('final-wrong').textContent = wrongCount;
            
            updateScore();
        }

        function showWrongAnswers() {
            wrongNoteList.innerHTML = '';
            
            if (wrongAnswers.length === 0) {
                wrongNoteEmpty.classList.remove('hidden');
            } else {
                wrongNoteEmpty.classList.add('hidden');
                wrongAnswers.slice().reverse().forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-3 border rounded-xl bg-gray-50 shadow-sm';
                    itemEl.innerHTML = `
                        <div class="font-bold text-xl text-gray-800 mb-1">
                            ${item.word}
                            <span class="text-sm text-gray-500 ml-2 font-normal">(${item.meaning})</span>
                        </div>
                        <div class="text-sm text-red-600 mb-1">
                            <span class="font-semibold">ë‚´ ì˜¤ë‹µ:</span> <span class="font-mono">${item.wrongRomaji}</span>
                        </div>
                        <div class="text-sm text-green-600">
                            <span class="font-semibold">ì •ë‹µ:</span> <span class="font-mono">${item.correctRomaji}</span>
                        </div>
                    `;
                    wrongNoteList.appendChild(itemEl);
                });
            }

            wrongNoteModal.classList.remove('hidden');
            wrongNoteModal.classList.add('flex');
        }

        function closeWrongNoteModal() {
            wrongNoteModal.classList.add('hidden');
            wrongNoteModal.classList.remove('flex');
        }
        
        async function shareWrongAnswers() {
            if (wrongAnswers.length === 0) {
                alert("ê³µìœ í•  ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤!");
                return;
            }
            
            let shareText = `[ì¼ë³¸ì–´ ë¡œë§ˆì í‘œê¸° í…ŒìŠ¤íŠ¸ ì˜¤ë‹µ ë…¸íŠ¸]\nì´ ì˜¤ë‹µ ìˆ˜: ${wrongAnswers.length}ê°œ\n\n`;
            
            wrongAnswers.forEach((item, index) => {
                shareText += `--- ì˜¤ë‹µ #${index + 1} ---\n`;
                shareText += `ë‹¨ì–´: ${item.word} (${item.meaning})\n`;
                shareText += `ë‚´ ì˜¤ë‹µ: ${item.wrongRomaji}\n`;
                shareText += `ì •ë‹µ: ${item.correctRomaji}\n\n`;
            });
            
            const shareData = {
                title: 'ë¡œë§ˆì í‘œê¸° ì˜¤ë‹µ ë…¸íŠ¸',
                text: shareText,
            };
            
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else if (navigator.clipboard) {
                    await navigator.clipboard.writeText(shareText);
                    alert("ê³µìœ  ê¸°ëŠ¥ì´ ì§€ì›ë˜ì§€ ì•Šì•„ í´ë¦½ë³´ë“œì— ì˜¤ë‹µ ë…¸íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
                } else {
                    alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                if (error.name !== 'AbortError') { 
                    console.error('Sharing failed:', error);
                }
            }
        }

        // --- ì´ë²¤íŠ¸ ë°”ì¸ë”© ---
        startQuizBtn.addEventListener('click', startQuiz);
        wrongNoteBtn.addEventListener('click', showWrongAnswers);
        finalWrongNoteBtn.addEventListener('click', showWrongAnswers);
        shareBtn.addEventListener('click', shareWrongAnswers);

        selectAllGroups.addEventListener('change', (e) => {
            document.querySelectorAll('input[name="group-select"]').forEach(cb => cb.checked = e.target.checked);
        });

        loadJapaneseVocaBtn.addEventListener('click', () => {
            const japaneseVocaFile = 'japanese.voca';
            const isCurrentlyLoading = currentFilesToLoad.includes(japaneseVocaFile);
            
            if (isCurrentlyLoading) {
                currentFilesToLoad = currentFilesToLoad.filter(f => f !== japaneseVocaFile);
                loadJapaneseVocaBtn.classList.replace('bg-green-100', 'bg-blue-100');
                loadJapaneseVocaBtn.classList.replace('text-green-800', 'text-blue-800');
                vocaBtnText.textContent = 'ë‹¨ì–´ì¥ í¬í•¨í•˜ê¸°';
            } else {
                currentFilesToLoad.push(japaneseVocaFile);
                loadJapaneseVocaBtn.classList.replace('bg-blue-100', 'bg-green-100');
                loadJapaneseVocaBtn.classList.replace('text-blue-800', 'text-green-800');
                vocaBtnText.textContent = 'ì½ê¸° ì—°ìŠµ ìë£Œë§Œ';
            }

            loadVocabulary();
        });

        checkBtn.addEventListener('click', checkAnswer);
        
        romajiInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                if (!checkBtn.classList.contains('hidden')) {
                    checkAnswer();
                }
            }
        });
        
        nextBtn.addEventListener('keydown', (e) => {
             if (e.key === 'Enter') {
                 e.preventDefault();
                 romajiInput.classList.remove('text-green-600', 'text-red-500', 'font-bold', 'shake');
                 loadNextQuestion();
             }
        });

        nextBtn.addEventListener('click', () => {
            romajiInput.classList.remove('text-green-600', 'text-red-500', 'font-bold', 'shake');
            loadNextQuestion();
        });

        quitBtn.addEventListener('click', finishQuiz);
        
        restartBtn.addEventListener('click', () => {
            finalView.classList.add('hidden');
            setupView.classList.remove('hidden');
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadVocabulary();
        });

    </script>
</body>
</html>
