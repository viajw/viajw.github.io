<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일본어 단어장</title>
    <!-- 1. Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Pretendard (한글/영어), Noto Sans JP (일본어) 웹 폰트 로드 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS 설정 스크립트 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Pretendard', 'Noto Sans JP', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    
    <style>
        /* [수정] 단어/뜻 가리기 스타일 (셀 전체) */
        .hide-cell-content {
            background-color: #f3f4f6 !important; /* bg-gray-100 */
            border-radius: 4px;
            user-select: none;
        }
        /* [수정] 셀 안의 텍스트(span)를 투명하게 만듦 */
        .hide-cell-content > span {
            color: transparent !important;
            user-select: none;
        }

        /* [수정] 단어 가리기를 해도 사전 버튼은 보이도록 */
        .hide-cell-content .dictionary-link {
            color: #6b7280 !important; /* gray-500 */
            background-color: transparent !important;
        }

        /* [추가] 그룹 팝업 스타일 */
        .group-popup {
            position: absolute;
            bottom: 100%; /* 단어 셀 바로 위에 */
            left: 50%;
            transform: translateX(-50%);
            background-color: #374151; /* gray-700 */
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.875rem; /* text-sm */
            white-space: nowrap;
            margin-bottom: 4px;
            z-index: 10;
            /* 말풍선 꼬리 */
            &::after {
                content: '';
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 5px;
                border-style: solid;
                border-color: #374151 transparent transparent transparent;
            }
        }
    </style>
</head>
<!-- [수정] 세로 중앙 정렬을 위해 flex 추가 -->
<body class="bg-gray-100 min-h-screen font-sans flex items-center justify-center">

    <!-- 전체 컨테이너 -->
    <div class="container mx-auto max-w-2xl w-full p-4">
        
        <!-- === 1. 설정 화면 (기본 표시) === -->
        <div id="setup-container">
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">
                    단어장: 설정
                </h1>
                
                <!-- 1. 그룹 선택 -->
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">
                        표시할 그룹 선택
                    </h2>
                    <div class="border rounded-lg p-4 max-h-60 overflow-y-auto">
                        <div class="flex items-center border-b pb-2 mb-2">
                            <input id="select-all-groups" type="checkbox" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="select-all-groups" class="ml-3 block text-base font-bold text-gray-900">
                                전체 선택
                            </label>
                        </div>
                        <div id="group-checkbox-list" class="space-y-2 mt-2">
                            <!-- JS로 그룹 체크박스 생성 -->
                            <p class="text-gray-500">vocabulary.txt 파일을 불러오는 중...</p>
                        </div>
                    </div>
                    <p id="group-selection-error" class="text-red-500 text-sm mt-2 hidden">
                        표시할 그룹을 1개 이상 선택하세요.
                    </p>
                </div>

                <!-- 단어장 보기 버튼 -->
                <button id="show-wordlist-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 shadow-md">
                    단어장 보기
                </button>
            </div>
        </div>

        <!-- === 2. 단어장 화면 (숨겨짐) === -->
        <div id="wordlist-container" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
                <!-- 헤더: 제목 + 설정 버튼 -->
                <div class="flex justify-between items-center mb-4">
                    <h1 id="main-title" class="text-xl sm:text-2xl font-bold text-gray-800">
                        단어장
                    </h1>
                    <div class="flex space-x-2">
                        <button id="randomize-btn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-3 rounded-lg transition-colors duration-200">
                            랜덤
                        </button>
                        <button id="back-to-setup-btn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-3 rounded-lg transition-colors duration-200">
                            ← 설정
                        </button>
                    </div>
                </div>

                <!-- 선택된 범위 표시 -->
                <div id="selected-scopes-container" class="mb-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-600 border">
                    <!-- JS로 선택 범위 표시 -->
                </div>
                
                <!-- 툴바 (버튼 색상 변경) -->
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button id="toggle-word-btn" class="w-full text-sm bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-2 px-3 rounded-lg transition-colors duration-200">
                        단어 가리기
                    </button>
                    <button id="toggle-meaning-btn" class="w-full text-sm bg-green-100 hover:bg-green-200 text-green-800 font-semibold py-2 px-3 rounded-lg transition-colors duration-200">
                        뜻 가리기
                    </button>
                    <!-- [수정] 단어 선택하기 버튼 (회색) -->
                    <button id="toggle-select-mode-btn" class="w-full text-sm bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-3 rounded-lg transition-colors duration-200">
                        단어 선택하기
                    </button>
                </div>

                <!-- 단어장 테이블 -->
                <div class="overflow-x-auto max-h-[60vh] overflow-y-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <!-- 선택 체크박스 헤더 (숨겨짐) -->
                                <th id="select-col-header" class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12 hidden">
                                    <input type="checkbox" id="select-all-words" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                </th>
                                <!-- 3열 구조 -->
                                <th scope="col" class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    단어
                                </th>
                                <th scope="col" class="p-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-16">
                                    사전
                                </th>
                                <th scope="col" class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    뜻
                                </th>
                            </tr>
                        </thead>
                        <tbody id="wordlist-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- JS로 단어 목록 생성 -->
                        </tbody>
                    </table>
                </div>

                <!-- 선택 공유 버튼 (숨겨짐) -->
                <button id="share-selected-btn" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 shadow-md mt-4">
                    선택한 단어 공유하기
                </button>

            </div>
        </div>
    </div>

    <script>
        // --- 1. DOM 요소 ---
        const setupContainer = document.getElementById('setup-container');
        const wordlistContainer = document.getElementById('wordlist-container');
        
        // 설정 화면
        const groupCheckboxList = document.getElementById('group-checkbox-list');
        const selectAllGroups = document.getElementById('select-all-groups');
        const groupSelectionError = document.getElementById('group-selection-error');
        const showWordlistBtn = document.getElementById('show-wordlist-btn');

        // 단어장 화면
        const mainTitle = document.getElementById('main-title');
        const selectedScopesContainer = document.getElementById('selected-scopes-container');
        const backToSetupBtn = document.getElementById('back-to-setup-btn');
        const randomizeBtn = document.getElementById('randomize-btn');
        const toggleWordBtn = document.getElementById('toggle-word-btn');
        const toggleMeaningBtn = document.getElementById('toggle-meaning-btn');
        const wordlistTableBody = document.getElementById('wordlist-table-body');
        
        // 선택 공유 요소
        const toggleSelectModeBtn = document.getElementById('toggle-select-mode-btn');
        const shareSelectedBtn = document.getElementById('share-selected-btn');
        const selectAllWords = document.getElementById('select-all-words');
        const selectColHeader = document.getElementById('select-col-header');
        
        // --- 2. 데이터 변수 ---
        let wordGroups = {}; // { '그룹명': [{ word, meaning, group }, ...] }
        let allGroups = [];   // ['그룹명1', '그룹명2', ...]
        let activeWordList = []; // 현재 표시 중인 단어 목록
        let isWordHidden = false;
        let isMeaningHidden = false;
        let isSelectMode = false;

        // --- 3. 함수 ---

        /**
         * txt 파일 로드 및 그룹 파싱
         */
        async function loadVocabulary() {
            try {
                const response = await fetch('vocabulary.txt', { cache: 'no-store' });
                if (!response.ok) throw new Error('파일 로딩 실패');
                const text = await response.text();
                
                wordGroups = {};
                allGroups = [];
                let currentGroup = '미분류';

                const lines = text.split('\n');

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    
                    if (trimmedLine.startsWith('@')) {
                        currentGroup = trimmedLine.substring(1).trim() || '미분류';
                        if (!wordGroups[currentGroup]) {
                            wordGroups[currentGroup] = [];
                            allGroups.push(currentGroup);
                        }
                    } else if (trimmedLine.length > 0 && !trimmedLine.startsWith('#')) {
                        const parts = trimmedLine.split(' - ');
                        if (parts.length >= 2) {
                            const word = parts[0].trim();
                            const meaning = parts.slice(1).join(' - ').trim();
                            
                            if (!wordGroups[currentGroup]) {
                                wordGroups[currentGroup] = [];
                                allGroups.push(currentGroup);
                            }
                            wordGroups[currentGroup].push({ word, meaning, group: currentGroup });
                        }
                    }
                }
                displayGroupCheckboxes();
            } catch (error) {
                console.error(error);
                groupCheckboxList.innerHTML = `<p class="text-red-500">vocabulary.txt 파일을 불러올 수 없습니다.</p>`;
            }
        }

        /**
         * 설정 화면에 그룹 체크박스 표시
         */
        function displayGroupCheckboxes() {
            groupCheckboxList.innerHTML = '';
            if (allGroups.length === 0) {
                groupCheckboxList.innerHTML = `<p class="text-gray-500">단어 그룹을 찾을 수 없습니다.</p>`;
                return;
            }

            allGroups.forEach(group => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input id="group-${group}" type="checkbox" name="group-select" value="${group}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="group-${group}" class="ml-3 block text-sm text-gray-700">
                        ${group}
                    </label>
                `;
                groupCheckboxList.appendChild(div);
            });
        }

        /**
         * 단어장 화면에 목록 표시
         */
        function displayWordList(list) {
            wordlistTableBody.innerHTML = '';
            
            list.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'word-row';

                // 1. 선택 모드용 체크박스 셀
                const tdSelect = document.createElement('td');
                tdSelect.className = 'select-col p-3 align-middle hidden';
                tdSelect.innerHTML = `
                    <input type="checkbox" class="word-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" 
                           data-word="${item.word}" data-meaning="${item.meaning}">
                `;

                // 2. 단어 셀 (그룹 팝업 + 가리기 기능)
                const tdWord = document.createElement('td');
                tdWord.className = 'word-cell p-3 align-middle relative';
                const wordSpan = document.createElement('span');
                wordSpan.className = 'text-base font-medium text-gray-900';
                wordSpan.textContent = item.word;
                if (isWordHidden) {
                    tdWord.classList.add('hide-cell-content'); // [수정] 셀 전체에 가리기 적용
                }
                
                // 그룹 팝업 이벤트
                wordSpan.onclick = () => showGroupPopup(wordSpan, item.group);
                tdWord.appendChild(wordSpan);

                // 3. 사전 버튼 셀
                const tdDict = document.createElement('td');
                tdDict.className = 'dict-cell p-3 align-middle text-center';
                const dictButton = document.createElement('button');
                dictButton.className = 'dictionary-link text-gray-500 hover:text-blue-600 transition-colors duration-150';
                // [수정] 사전 아이콘 SVG (외부 링크)
                dictButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"> <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 0 0-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75v-4a.75.75 0 0 1 1.5 0v4A2.25 2.25 0 0 1 12.75 17H4.25A2.25 2.25 0 0 1 2 14.75v-8.5A2.25 2.25 0 0 1 4.25 4h5a.75.75 0 0 1 0 1.5h-5Z" clip-rule="evenodd" /> <path fill-rule="evenodd" d="M6.19 14.25a.75.75 0 1 1-1.06-1.06L13.94 4.44a.75.75 0 0 1 1.06 0l.75.75a.75.75 0 0 1 0 1.06L6.19 14.25Z" clip-rule="evenodd" /> </svg>`;
                dictButton.onclick = (e) => {
                    e.stopPropagation(); // 팝업 이벤트 방지
                    openDictionary(item.word);
                };
                tdDict.appendChild(dictButton);

                // 4. 뜻 셀
                const tdMeaning = document.createElement('td');
                tdMeaning.className = 'meaning-cell p-3 align-middle';
                const meaningSpan = document.createElement('span');
                meaningSpan.className = 'text-sm text-gray-700';
                meaningSpan.textContent = item.meaning;
                if (isMeaningHidden) {
                    tdMeaning.classList.add('hide-cell-content'); // [수정] 셀 전체에 가리기 적용
                }
                
                // 뜻 클릭 시 팝업 닫기
                tdMeaning.onclick = closeAllPopups;
                
                tdMeaning.appendChild(meaningSpan);

                // 셀 조합
                tr.appendChild(tdSelect);
                tr.appendChild(tdWord);
                tr.appendChild(tdDict);
                tr.appendChild(tdMeaning);
                wordlistTableBody.appendChild(tr);
            });
            
            // 선택 모드 상태에 따라 체크박스 열 표시/숨김
            updateSelectModeUI();
        }

        /**
         * 그룹 팝업 표시
         */
        function showGroupPopup(targetElement, group) {
            closeAllPopups(); // 기존 팝업 닫기
            
            const popup = document.createElement('div');
            popup.className = 'group-popup';
            popup.textContent = group;
            
            targetElement.closest('td').appendChild(popup);
        }

        /**
         * 모든 그룹 팝업 닫기
         */
        function closeAllPopups() {
            document.querySelectorAll('.group-popup').forEach(p => p.remove());
        }

        /**
         * 사전 링크 열기
         */
        function openDictionary(word) {
            let searchTerm = word;
            // yomi(kanji)okurigana 형태 (예: やさ(優)しい)
            const matchYomiKanji = word.match(/([^(]+)\(([\u4E00-\u9FAF]+)\)(.*)/);
            
            if (matchYomiKanji) {
                // $1: やさ, $2: 優, $3: 喱 -> 優しい
                searchTerm = matchYomiKanji[1] + matchYomiKanji[2] + matchYomiKanji[3];
            } else {
                // kanji(yomi) 형태 (예: 漢字(かんじ))
                // 또는 괄호 없는 단어
                searchTerm = word.split(/[\(|（]/)[0].trim();
            }
            
            const url = `https://ja.dict.naver.com/#/search?range=word&query=${encodeURIComponent(searchTerm)}`;
            window.open(url, '_blank');
        }

        /**
         * 선택된 범위 텍스트 표시
         */
        function displaySelectedScopes() {
            const selectedGroups = Array.from(document.querySelectorAll('input[name="group-select"]:checked'))
                                      .map(cb => cb.value);
            
            let scopeText = "선택 범위: ";
            if (selectedGroups.length === allGroups.length || selectedGroups.length === 0) {
                scopeText += "단어장 전체";
            } else {
                scopeText += selectedGroups.join(', ');
            }
            selectedScopesContainer.textContent = scopeText;
        }

        /**
         * 선택 모드 UI 업데이트
         */
        function updateSelectModeUI() {
            const cols = document.querySelectorAll('.select-col, #select-col-header');
            if (isSelectMode) {
                cols.forEach(col => col.classList.remove('hidden'));
                shareSelectedBtn.classList.remove('hidden');
                toggleSelectModeBtn.textContent = '선택 취소';
                // [수정] 버튼 색상 변경 (회색 -> 빨강)
                toggleSelectModeBtn.classList.replace('bg-gray-100', 'bg-red-100');
                toggleSelectModeBtn.classList.replace('hover:bg-gray-200', 'hover:bg-red-200');
                toggleSelectModeBtn.classList.replace('text-gray-800', 'text-red-800');
            } else {
                cols.forEach(col => col.classList.add('hidden'));
                shareSelectedBtn.classList.add('hidden');
                toggleSelectModeBtn.textContent = '단어 선택하기';
                // [수정] 버튼 색상 변경 (빨강 -> 회색)
                toggleSelectModeBtn.classList.replace('bg-red-100', 'bg-gray-100');
                toggleSelectModeBtn.classList.replace('hover:bg-red-200', 'hover:bg-gray-200');
                toggleSelectModeBtn.classList.replace('text-red-800', 'text-gray-800');
                // 모든 체크박스 해제
                selectAllWords.checked = false;
                document.querySelectorAll('.word-checkbox').forEach(cb => cb.checked = false);
            }
        }

        // --- 4. 이벤트 리스너 ---

        // "단어장 보기" 버튼
        showWordlistBtn.addEventListener('click', () => {
            const selectedGroups = Array.from(document.querySelectorAll('input[name="group-select"]:checked'))
                                      .map(cb => cb.value);
            
            if (selectedGroups.length === 0) {
                groupSelectionError.classList.remove('hidden');
                return;
            }
            
            groupSelectionError.classList.add('hidden');
            
            activeWordList = [];
            selectedGroups.forEach(group => {
                activeWordList.push(...wordGroups[group]);
            });
            
            // [수정] 설정에서 돌아올 때는 항상 기본 순서
            // activeWordList.sort(() => ...); // 자동 랜덤 제거

            displaySelectedScopes();
            displayWordList(activeWordList);
            
            setupContainer.classList.add('hidden');
            wordlistContainer.classList.remove('hidden');
        });

        // "← 설정" 버튼
        backToSetupBtn.addEventListener('click', () => {
            wordlistContainer.classList.add('hidden');
            setupContainer.classList.remove('hidden');
            
            // 설정 복귀 시 선택 모드 초기화
            if (isSelectMode) {
                isSelectMode = false;
                updateSelectModeUI();
            }
            // [추가] 설정 복귀 시 가리기 모드 초기화
            if (isWordHidden) {
                isWordHidden = false;
                toggleWordBtn.textContent = '단어 가리기';
            }
            if (isMeaningHidden) {
                isMeaningHidden = false;
                toggleMeaningBtn.textContent = '뜻 가리기';
            }
        });

        // "랜덤" 버튼
        randomizeBtn.addEventListener('click', () => {
            activeWordList.sort(() => Math.random() - 0.5);
            displayWordList(activeWordList);
        });

        // "전체 선택" (그룹)
        selectAllGroups.addEventListener('change', () => {
            document.querySelectorAll('input[name="group-select"]')
                    .forEach(cb => cb.checked = selectAllGroups.checked);
        });

        // "단어 가리기"
        toggleWordBtn.addEventListener('click', () => {
            isWordHidden = !isWordHidden;
            toggleWordBtn.textContent = isWordHidden ? '단어 보이기' : '단어 가리기';
            // [수정] 셀 전체에 적용/제거
            wordlistTableBody.querySelectorAll('.word-cell').forEach(cell => {
                cell.classList.toggle('hide-cell-content', isWordHidden);
            });
        });

        // "뜻 가리기"
        toggleMeaningBtn.addEventListener('click', () => {
            isMeaningHidden = !isMeaningHidden;
            toggleMeaningBtn.textContent = isMeaningHidden ? '뜻 보이기' : '뜻 가리기';
            // [수정] 셀 전체에 적용/제거
            wordlistTableBody.querySelectorAll('.meaning-cell').forEach(cell => {
                cell.classList.toggle('hide-cell-content', isMeaningHidden);
            });
        });
        
        // "단어 선택하기"
        toggleSelectModeBtn.addEventListener('click', () => {
            isSelectMode = !isSelectMode;
            updateSelectModeUI();
        });

        // "전체 선택" (단어)
        selectAllWords.addEventListener('change', () => {
            document.querySelectorAll('.word-checkbox')
                    .forEach(cb => cb.checked = selectAllWords.checked);
        });

        // "선택한 단어 공유하기"
        shareSelectedBtn.addEventListener('click', async () => {
            const selectedItems = [];
            document.querySelectorAll('.word-checkbox:checked').forEach(cb => {
                selectedItems.push(`${cb.dataset.word} - ${cb.dataset.meaning}`);
            });

            if (selectedItems.length === 0) {
                // [수정] alert 대신 커스텀 UI (추후 확장 가능)
                alert('공유할 단어를 1개 이상 선택하세요.');
                return;
            }

            const title = "나의 단어장";
            const text = `${title}\n(총 ${selectedItems.length}개)\n\n${selectedItems.join('\n')}`;

            if (navigator.share) {
                try {
                    await navigator.share({ title, text });
                } catch (err) {
                    console.error('Share failed:', err);
                }
            } else {
                // 데스크톱 등 Web Share API 미지원 시 클립보드 복사
                try {
                    await navigator.clipboard.writeText(text);
                    shareSelectedBtn.textContent = '✅ 클립보드에 복사됨!';
                    setTimeout(() => {
                        shareSelectedBtn.textContent = '선택한 단어 공유하기';
                    }, 2000);
                } catch (err) {
                    console.error('Clipboard copy failed:', err);
                    alert('클립보드 복사에 실패했습니다.');
                }
            }
        });

        // --- 5. 초기 실행 ---
        loadVocabulary();

    </script>
</body>
</html>

